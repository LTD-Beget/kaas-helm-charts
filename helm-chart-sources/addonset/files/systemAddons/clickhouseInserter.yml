apiVersion: addons.in-cloud.io/v1alpha1
kind: Addon
metadata:
  name: clickhouse-inserter
  annotations:
    gotemplating.fn.crossplane.io/composition-resource-name: addonClickhouseInserter
    gotemplating.fn.crossplane.io/ready: "True"
spec:
  chart: ""
  path: "helm-chart-sources/victoria-metrics-k8s-stack"
  pluginName: helm-with-values
  repoURL: "https://github.com/LTD-Beget/kaas-helm-charts"
  version: "HEAD"
  targetCluster: in-cluster
  targetNamespace: "beget-clickhouse-vmstorage"
  variables:
    cluster_name: in-cluster
  valuesSources: []
  initDependencies:
    # - name: vm-operator
    #   criteria:
    #     - jsonPath: $.status.conditions[?(@.type=='Ready')].status
    #       operator: Equal
    #       value: "True"
    - name: vm-cluster #TODO
      criteria:
        - jsonPath: $.status.conditions[?(@.type=='Ready')].status
          operator: Equal
          value: "True"
    - name: clickhouse-vmstorage
      criteria:
        - jsonPath: $.status.conditions[?(@.type=='Ready')].status
          operator: Equal
          value: "True"

  backend: 
    type: "argocd"
    namespace: "beget-argocd"
    project: "default"
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      managedNamespaceMetadata:
        labels:
          in-cloud.io/caBundle: approved
          in-cloud.io/clusterName: infra
      syncOptions:
        - CreateNamespace=true
  valuesSelectors:
    - name: default
      priority: 0
      matchLabels:
        addons.in-cloud.io/values: default
        addons.in-cloud.io/addon: clickhouse-inserter
    - name: infra
      priority: 10
      matchLabels:
        addons.in-cloud.io/values: infra
        addons.in-cloud.io/addon: clickhouse-inserter

---
apiVersion: addons.in-cloud.io/v1alpha1
kind: AddonValue
metadata:
  name: clickhouse-inserter-default
  annotations:
    gotemplating.fn.crossplane.io/composition-resource-name: addonValueClickhouseInserterDefault
    gotemplating.fn.crossplane.io/ready: "True"
  labels:
    addons.in-cloud.io/values: default
    addons.in-cloud.io/addon: clickhouse-inserter
spec:
  values: |
    victoria-metrics-k8s-stack:
      fullnameOverride: clickhouse-inserter
      alertmanager:
        enabled: false
      defaultRules:
        create: false
      clickhouseIserter:
        enabled: true
      prometheus-node-exporter:
        enabled: false
      serviceAccount:
        create: false
      victoria-metrics-operator:
        enabled: false
      vmagent:
        enabled: false
      vmalert:
        enabled: true
        spec:
          serviceSpec:
            metadata:
              name: clickhouse-inserter
              labels:
                monitoring.in-cloud.io/service: clickhouse-inserter
            spec:
              ports:
                - name: http
                  port: 8080
                  protocol: TCP
                  targetPort: 8080
          extraArgs:
            'notifier.blackhole': "true"
          tolerations:
            - key: "node-role.kubernetes.io/control-plane"
              operator: "Exists"
              effect: "NoSchedule"
            - key: "node-role.kubernetes.io/master"
              operator: "Exists"
              effect: "NoSchedule"
          externalLabels:
            in-cloud-metrics: "clickhouse"
          podMetadata:
            labels:
              in-cloud-metrics: "clickhouse"
          evaluationInterval: 60s
          selectAllByDefault: false
          ruleNamespaceSelector: {}
          ruleSelector:
            matchLabels:
              in-cloud-metrics: "clickhouse"
          resources:
            limits:
              cpu: 1
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 128Mi
          replicaCount: 1
          updateStrategy: RollingUpdate
          extraEnvs:
            - name: GOMAXPROCS
              value: "4"
          remoteWrite:
            url: "http://clickhouse-vmstorage.beget-clickhouse-vmstorage.svc:9363/promrw"
            concurrency: 4
            basicAuth:
              username:
                name: clickhouse-credentials
                key: username
              password:
                name: clickhouse-credentials
                key: password
          remoteRead:
            url: "http://vmselect.beget-vmcluster.svc:8481/select/0/prometheus"
          datasource:
            url: "http://vmselect.beget-vmcluster.svc:8481/select/0/prometheus"
      vmcluster:
        enabled: false
      vmsingle:
        enabled: false
      coreDns:
        enabled: false
      defaultDashboards:
        enabled: false
      kubeDns:
        enabled: false
      grafana:
        enabled: false
      kube-state-metrics:
        enabled: false
      kubeApiServer:
        enabled: false
      kubeControllerManager:
        enabled: false
      kubeEtcd:
        enabled: false
      kubeProxy:
        enabled: false
      kubeScheduler:
        enabled: false
      kubelet:
        enabled: false

---
apiVersion: addons.in-cloud.io/v1alpha1
kind: AddonValue
metadata:
  name: clickhouse-inserter-cert-manager
  annotations:
    gotemplating.fn.crossplane.io/composition-resource-name: addonValueClickhouseInserterCertManager
    gotemplating.fn.crossplane.io/ready: "True"
  labels:
    addons.in-cloud.io/values: cert-manager
    addons.in-cloud.io/addon: clickhouse-inserter
spec:
  values: |
    victoria-metrics-k8s-stack:
      vmalert:
        enabled: true
        spec:
          serviceSpec:
            spec:
              ports:
                - name: http
                  port: 8080
                  protocol: TCP
                  targetPort: 8080
                - name: https-metrics
                  port: 11043
                  protocol: TCP
                  targetPort: https-metrics
          containers:
            - name: rbac-proxy
              image: gcr.io/kubebuilder/kube-rbac-proxy:v0.14.4
              args:
                - --secure-listen-address=0.0.0.0:11043
                - --upstream=http://127.0.0.1:8080
                - --tls-cert-file=/app/config/metrics/tls/tls.crt
                - --tls-private-key-file=/app/config/metrics/tls/tls.key
                - --v=2
              ports:
                - name: https-metrics
                  containerPort: 11043
                  protocol: TCP
              resources:
                requests:
                  memory: "32Mi"
                  cpu: "10m"
                limits:
                  memory: "64Mi"
                  cpu: "50m"
              volumeMounts:
                - name: rbac-proxy-tls
                  mountPath: /app/config/metrics/tls
                  readOnly: true
                - mountPath: /etc/ssl/certs
                  name: trusted-ca-certs
                  readOnly: true
          volumes:
            - name: rbac-proxy-tls
              secret:
                defaultMode: 420
                secretName: clickhouse-inserter-monitoring-svc-tls
            - name: trusted-ca-certs
              configMap:
                name: ca
          remoteRead:
            url: "https://vmselect.beget-vmcluster.svc:8481/select/0/prometheus"
            tlsConfig:
              ca:
                configMap:
                  name: ca
                  key: ca.crt
          datasource:
            url: "https://vmselect.beget-vmcluster.svc:8481/select/0/prometheus"
            tlsConfig:
              ca:
                configMap:
                  name: ca
                  key: ca.crt

    monitoring:
      enabled: true
      secureService:
        enabled: true
        issuer:
          name: selfsigned-cluster-issuer

---
apiVersion: addons.in-cloud.io/v1alpha1
kind: AddonPhase
metadata:
  annotations:
    gotemplating.fn.crossplane.io/composition-resource-name: addonPhaseClickhouseInserter
    gotemplating.fn.crossplane.io/ready: "True"
  name: clickhouse-inserter
spec:
  rules:
    - name: cert-manager
      criteria:
        - source:
            apiVersion: addons.in-cloud.io/v1alpha1
            kind: Addon
            name: cert-manager
          jsonPath: $.status.conditions[?(@.type=='Ready')].status
          operator: Equal
          value: "True"
        - source:
            apiVersion: addons.in-cloud.io/v1alpha1
            kind: Addon
            name: trust-manager
          jsonPath: $.status.conditions[?(@.type=='Ready')].status
          operator: Equal
          value: "True"
      selector:
        name: cert-manager
        priority: 20
        matchLabels:
          addons.in-cloud.io/values: cert-manager
          addons.in-cloud.io/addon: clickhouse-inserter-cert-manager
