{{- if and .Values.tls.enabled (.Values.tls.server.enabled) }}
{{- $defaults := .Values.tls.defaults | default dict }}
{{- $defDuration := $defaults.duration | default "8760h" }}
{{- $defRenew   := $defaults.renewBefore | default "720h" }}
{{- $defPK      := $defaults.privateKey | default (dict "algorithm" "RSA" "size" 2048) }}

{{- $srv       := .Values.tls.server | default dict }}
{{- $srvCert   := $srv.certificate | default dict }}
{{- $srvPK     := $srvCert.privateKey | default $defPK }}
{{- $srvUsages := $srvCert.usages | default (list "digital signature" "key encipherment" "server auth") }}
{{- $issuer    := $srv.issuer | default dict }}

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ default "vault-tls-server" $srvCert.name }}
  namespace: {{ .Release.Namespace }}
spec:
  secretName: {{ default "vault-tls" $srvCert.secretName }}
  duration: {{ default $defDuration $srvCert.duration }}
  renewBefore: {{ default $defRenew $srvCert.renewBefore }}
  commonName: {{ default "vault" $srvCert.commonName }}
  {{- with $srvCert.dnsNames }}
  dnsNames:
    {{- range . }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}
  privateKey:
    algorithm: {{ $srvPK.algorithm }}
    size: {{ $srvPK.size }}
  usages:
    {{- range $srvUsages }}
    - {{ . }}
    {{- end }}
  issuerRef:
    name: {{ required "tls.server.issuer.name is required" $issuer.name }}
    kind: {{ default "ClusterIssuer" $issuer.kind }}
    group: {{ default "cert-manager.io" $issuer.group }}
{{- end }}