{{- range $appName, $appValue := .Values.applications }}
  {{- if $appValue.enabled }}

    {{- if and $appValue.issuers.kubernetesCA.enabled (eq $appValue.issuers.kubernetesCA.type "selfsigned") }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: kubernetes-ca
  namespace: beget-system
  labels:
    cluster.x-k8s.io/cluster-name: my-first-client
spec:
  isCA: true
  commonName: kubernetes-ca
  secretName: {{ $appValue.issuers.kubernetesCA.secretName }}
  duration: 87600h
  renewBefore: 80000h
  privateKey:
    algorithm: RSA
    size: 2048
    rotationPolicy: Never
  issuerRef:
    name: selfsigned
    kind: Issuer
  usages:
    - cert sign
    - key encipherment
    - digital signature
  secretTemplate:
    labels:
      cluster.x-k8s.io/cluster-name: my-first-client
    {{- end }}

    {{- if and $appValue.issuers.frontProxyCA.enabled (eq $appValue.issuers.frontProxyCA.type "selfsigned") }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: front-proxy-ca
  namespace: beget-system
  labels:
    cluster.x-k8s.io/cluster-name: my-first-client
spec:
  isCA: true
  commonName: front-proxy-ca
  secretName: {{ $appValue.issuers.frontProxyCA.secretName }}
  duration: 87600h
  renewBefore: 80000h
  privateKey:
    algorithm: RSA
    size: 2048
    rotationPolicy: Never
  issuerRef:
    name: selfsigned
    kind: Issuer
  usages:
    - cert sign
    - key encipherment
    - digital signature
  secretTemplate:
    labels:
      cluster.x-k8s.io/cluster-name: my-first-client
    {{- end }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: apiserver
  namespace: beget-system
spec:
  secretName: apiserver-tls
  duration: 8760h
  renewBefore: 720h
  commonName: kube-apiserver
  dnsNames:
    {{- range $dns := $appValue.containers.kubeApiserver.certSANs }}
    - {{ tpl $dns $ }}
    {{- end }}
  ipAddresses:
    {{- range $ip := $appValue.containers.kubeApiserver.certIPs }}
    - {{ $ip | quote }}
    {{- end }}
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: kubernetes-ca
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: front-proxy-client
  namespace: beget-system
spec:
  secretName: front-proxy-client-tls
  duration: 8760h
  renewBefore: 720h
  commonName: front-proxy-client
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - key encipherment
    - data encipherment
    - client auth
  issuerRef:
    name: front-proxy-ca
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: apiserver-kubelet-client
  namespace: beget-system
spec:
  secretName: apiserver-kubelet-client-tls
  duration: 8760h
  renewBefore: 720h
  commonName: kube-apiserver-kubelet-client
  subject:
    organizations:
      - kubeadm:cluster-admins
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - key encipherment
    - data encipherment
    - client auth
  issuerRef:
    name: kubernetes-ca
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: controller-manager-kubeconfig-client
  namespace: beget-system
spec:
  secretName: controller-manager-kubeconfig-client-tls
  duration: 8760h
  renewBefore: 720h
  isCA: false
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - client auth
    - key encipherment
    - data encipherment
  commonName: system:kube-controller-manager
  issuerRef:
    name: kubernetes-ca
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: scheduler-kubeconfig-client
  namespace: beget-system
spec:
  secretName: scheduler-kubeconfig-client-tls
  duration: 8760h
  renewBefore: 720h
  isCA: false
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - client auth
    - key encipherment
    - data encipherment
  commonName: system:kube-scheduler
  issuerRef:
    name: kubernetes-ca
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: service-account-ca
  namespace: beget-system
spec:
  secretName: service-account-ca-secret
  duration: 87600h
  renewBefore: 720h
  commonName: sa-token-signer.local
  isCA: true
  privateKey:
    algorithm: RSA
    size: 2048
    encoding: PKCS1
  usages:
    - cert sign
    - digital signature
  issuerRef:
    name: selfsigned
    kind: Issuer

{{- end }}
{{- end }}